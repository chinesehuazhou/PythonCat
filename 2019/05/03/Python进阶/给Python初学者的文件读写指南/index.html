<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="description" content="给Python初学者的文件读写指南（含基础与进阶，建议收藏） 对于初学者来说，一份详尽又清晰明白的指南很重要。今天，猫猫跟大家一起，好好学习Python文件读写的内容，这部分内容特别常用，掌握后对工作和实战都大有益处。学习是循序渐进的过程，欲速则不达。文章较长，建议大家收藏，以备复习查阅哦。 1、如何将列表数据写入文件？2、如何从文件中读取内容？3、多样需求的读写任务4、从with语句到上下文管理">
<meta property="og:type" content="article">
<meta property="og:title" content="豌豆花下猫">
<meta property="og:url" content="https://chinesehuazhou.github.io/2019/05/03/Python进阶/给Python初学者的文件读写指南/index.html">
<meta property="og:site_name" content="豌豆花下猫">
<meta property="og:description" content="给Python初学者的文件读写指南（含基础与进阶，建议收藏） 对于初学者来说，一份详尽又清晰明白的指南很重要。今天，猫猫跟大家一起，好好学习Python文件读写的内容，这部分内容特别常用，掌握后对工作和实战都大有益处。学习是循序渐进的过程，欲速则不达。文章较长，建议大家收藏，以备复习查阅哦。 1、如何将列表数据写入文件？2、如何从文件中读取内容？3、多样需求的读写任务4、从with语句到上下文管理">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2018-10-19T13:11:59.279Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="豌豆花下猫">
<meta name="twitter:description" content="给Python初学者的文件读写指南（含基础与进阶，建议收藏） 对于初学者来说，一份详尽又清晰明白的指南很重要。今天，猫猫跟大家一起，好好学习Python文件读写的内容，这部分内容特别常用，掌握后对工作和实战都大有益处。学习是循序渐进的过程，欲速则不达。文章较长，建议大家收藏，以备复习查阅哦。 1、如何将列表数据写入文件？2、如何从文件中读取内容？3、多样需求的读写任务4、从with语句到上下文管理">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://chinesehuazhou.github.io/2019/05/03/Python进阶/给Python初学者的文件读写指南/">





  <title> | 豌豆花下猫</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">豌豆花下猫</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://chinesehuazhou.github.io/2019/05/03/Python进阶/给Python初学者的文件读写指南/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="豌豆花下猫">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline"></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-03T21:21:22+08:00">
                2019-05-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="给Python初学者的文件读写指南（含基础与进阶，建议收藏）"><a href="#给Python初学者的文件读写指南（含基础与进阶，建议收藏）" class="headerlink" title="给Python初学者的文件读写指南（含基础与进阶，建议收藏）"></a>给Python初学者的文件读写指南（含基础与进阶，建议收藏）</h2><hr>
<p>对于初学者来说，一份详尽又清晰明白的指南很重要。今天，猫猫跟大家一起，好好学习Python文件读写的内容，这部分内容特别常用，掌握后对工作和实战都大有益处。学习是循序渐进的过程，欲速则不达。文章较长，建议大家收藏，以备复习查阅哦。</p>
<p>1、如何将列表数据写入文件？<br>2、如何从文件中读取内容？<br>3、多样需求的读写任务<br>4、从with语句到上下文管理器</p>
<h2 id="如何将列表数据写入文件？"><a href="#如何将列表数据写入文件？" class="headerlink" title="如何将列表数据写入文件？"></a>如何将列表数据写入文件？</h2><p>首先，我们来看看下面这段代码，并思考：这段代码有没有问题，如果有问题的话，要怎么改？<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">li = [&apos;python&apos;,&apos; is&apos;,&apos; a&apos;,&apos; cat&apos;]</span><br><span class="line">with open(&apos;test.txt&apos;,&apos;w&apos;) as f:</span><br><span class="line">    f.write(li)</span><br></pre></td></tr></table></figure></p>
<p>现在公布答案，这段代码会报错：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">TypeError  Traceback (most recent call last)</span><br><span class="line">&lt;ipython-input-6-57e0c2f5a453&gt; in &lt;module&gt;()</span><br><span class="line">      1 with open(&apos;test.txt&apos;,&apos;w&apos;) as f:</span><br><span class="line">----&gt; 2     f.write(li)</span><br><span class="line"></span><br><span class="line">TypeError: write() argument must be str, not list</span><br></pre></td></tr></table></figure></p>
<p>以上代码的想法是将list列表内容写入txt文件中，但是报错 TypeError: write() argument must be str。就是说，write()方法必须接受字符串（str）类型的参数。</p>
<p>Python中内置了str()方法，可以返回字符串版本的对象（Return a string version of object）。所以，上面的例子中，我们试试把 f.write(li) 改为 f.write(str(li)) ，先做一下字符串类型的转化看看。代码略。</p>
<p>这次没有报错了，但是打开文件就傻眼了吧，写入的内容是“[‘python’,’ is’,’ a’,’ cat’]”。怎么才能写成“python is a cat”呢？<br>文件写操作还有一个writelines()方法，它接收的参数是由字符串组成的序列（sequence），实际写入的效果是将全部字符串拼接在一起。字符串本身也是一种序列，所以当参数是字符串的时候，writelines()方法等价于write()。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># 以下3种写法等价，都是写入字符串“python is a cat”</span><br><span class="line">In [20]:  with open(&apos;test.txt&apos;,&apos;w&apos;) as f:</span><br><span class="line">    ...:      f.writelines([&apos;python&apos;,&apos; is&apos;,&apos; a&apos;,&apos; cat&apos;])</span><br><span class="line">    ...:      f.writelines(&apos;python is a cat&apos;)</span><br><span class="line">    ...:      f.write(&apos;python is a cat&apos;)</span><br><span class="line"></span><br><span class="line"># 以下2种写法等价，都是写入列表的字符串版本“[&apos;python&apos;,&apos; is&apos;,&apos; a&apos;,&apos; cat&apos;]”</span><br><span class="line">In [21]:  with open(&apos;test.txt&apos;,&apos;w&apos;) as f:</span><br><span class="line">    ...:      f.write(str([&apos;python&apos;,&apos; is&apos;,&apos; a&apos;,&apos; cat&apos;]))</span><br><span class="line">    ...:      f.writelines(str([&apos;python&apos;,&apos; is&apos;,&apos; a&apos;,&apos; cat&apos;]))</span><br><span class="line">    </span><br><span class="line"># 作为反例，以下写法都是错误的：</span><br><span class="line">In [22]:  with open(&apos;test.txt&apos;,&apos;w&apos;) as f:</span><br><span class="line">    ...:      f.writelines([2018,&apos;is&apos;,&apos;a&apos;,&apos;cat&apos;]) # 含非字符串</span><br><span class="line">    ...:      f.write([&apos;python&apos;,&apos;is&apos;,&apos;a&apos;,&apos;cat&apos;]) # 非字符串</span><br></pre></td></tr></table></figure>
<p>由上可知，当多段分散的字符串存在于列表中的时候，要用writelines()方法，如果字符串是一整段，那直接使用write()方法。如果要以整个列表的形式写入文件，就使用str()方法做下转化。</p>
<p>这个问题还没结束，如果列表中就是有元素不是字符串，而且要把全部元素取出来，怎么办呢？</p>
<p>那就不能直接使用write()和writelines()了，需要先用for循环，把每个元素取出来，逐一str()处理。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [37]: content=[1,&apos; is&apos;,&apos; everything&apos;]</span><br><span class="line">In [38]: with open(&apos;test.txt&apos;,&apos;w&apos;) as f:</span><br><span class="line">    ...:     for i in content:</span><br><span class="line">    ...:         f.write(str(i))</span><br></pre></td></tr></table></figure>
<p>需要注意的是，writelines()不会自动换行。如果要实现列表元素间的换行，一个办法是在每个元素后面加上换行符“\n”，如果不想改变元素，最好是用for循环，在写入的时候加在末尾：for i in content:  f.writelines(str(i)+“\n”)</p>
<p>引申一下，经过实验，数字及元祖类型也可以作为write()的参数，不需转化。但是dict字典类型不可以，需要先用str()处理一下。字典类型比较特殊，最好是用json.dump()方法写到文件，具体操作方法以及注意事项，请看喵喵之前发的《<a href="https://mp.weixin.qq.com/s/hR2Z_duLXnN0fQ3khDPiPQ" target="_blank" rel="noopener">假期玩得开心也不忘充电，学习Python操作JSON，网络数据交换不用愁</a>》</p>
<p>总结一下，write()接收字符串参数，适用于一次性将全部内容写入文件；writelines()接收参数是由字符串组成的序列，适用于将列表内容逐行写入文件。str()返回Python对象的字符串版本，使用需注意。</p>
<h2 id="如何从文件中读取内容？"><a href="#如何从文件中读取内容？" class="headerlink" title="如何从文件中读取内容？"></a>如何从文件中读取内容？</h2><p>从文件中读取内容有如下方法：</p>
<blockquote>
<p>file.read([size])<br>从文件读取指定的字节数，如果未给定或为负则读取所有。</p>
<p>file.readline([size])<br>读取整行，包括 “\n” 字符。</p>
<p>file.readlines([sizeint])<br>读取所有行并返回列表，若给定sizeint&gt;0，则是设置一次读多少字节，这是为了减轻读取压力。</p>
</blockquote>
<p>简而言之，在不传参数的情况下，read()对应write()，读取全部内容；readlines()对应writelines()，读取全部内容（含换行符）并以列表形式返回，每个换行的内容作为列表的一个元素。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [47]: with open(&apos;test.txt&apos;,&apos;r&apos;) as f:</span><br><span class="line">    ...:     print(f.read())</span><br><span class="line">1 is everything.</span><br><span class="line">python is a cat.</span><br><span class="line">this is the end.</span><br><span class="line"></span><br><span class="line">In [48]: with open(&apos;test.txt&apos;,&apos;r&apos;) as f:</span><br><span class="line">    ...:     print(f.readlines())</span><br><span class="line">[&apos;1 is everything.\n&apos;, &apos;python is a cat.\n&apos;, &apos;this is the end.&apos;]</span><br></pre></td></tr></table></figure></p>
<p>但是，以上两个方法有个缺点，当文件过大的时候，一次性读取太多内容，会对内存造成极大压力。读操作还有一个readline()方法，可以逐行读取。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">In [49]: with open(&apos;test.txt&apos;,&apos;r&apos;) as f:</span><br><span class="line">    ...:     print(f.readline())</span><br><span class="line">1 is everything.</span><br></pre></td></tr></table></figure></p>
<p>readline()读取第一行就返回，再次调用f.readline()，会读取下一行。</p>
<p>喵喵，是否感觉跟《<a href="https://mp.weixin.qq.com/s/OKf7N3xxrS0tJ_K8Srw-jA" target="_blank" rel="noopener">超强汇总：学习Python列表，只需这篇文章就够了</a>》学习过的生成器很像，需要不停调用next()获取下一行。</p>
<p>这么看来，readline()太笨拙了。那么，有什么办法可以优雅地读取文件内容呢？</p>
<p>回过头来看readlines()方法，它返回的是一个列表。这不奇怪么，好端端的内容为啥要返回成列表呢？</p>
<p>再想想writelines()方法，把字符串列表写入文件正是这家伙干的事，readlines()方法恰恰是它的逆操作！而writelines()方法要配合for循环，所以我们把readlines()与for循环结合，看看会怎样。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">In [61]: with open(&apos;test.txt&apos;,&apos;r&apos;) as f:</span><br><span class="line">    ...:     for line in f.readlines():</span><br><span class="line">    ...:         print(line)</span><br><span class="line">1 is everything.</span><br><span class="line"></span><br><span class="line">python is a cat.</span><br><span class="line"></span><br><span class="line">this is the end.</span><br><span class="line"></span><br><span class="line"># 读取内容包含换行符，所以要strip()去掉换行符</span><br><span class="line">In [62]: with open(&apos;test.txt&apos;,&apos;r&apos;) as f:</span><br><span class="line">    ...:     for line in f.readlines():</span><br><span class="line">    ...:         print(line.strip())</span><br><span class="line">1 is everything.</span><br><span class="line">python is a cat.</span><br><span class="line">this is the end.</span><br></pre></td></tr></table></figure>
<p>总结一下，readline()比较鸡肋，不咋用；read()适合读取内容较少的情况，或者是需要一次性处理全部内容的情况；而readlines()用的较多，比较灵活，因为for循环是一种迭代器，每次加载部分内容，既减少内存压力，又方便逐行对数据处理。</p>
<h2 id="多样需求的读写任务"><a href="#多样需求的读写任务" class="headerlink" title="多样需求的读写任务"></a>多样需求的读写任务</h2><p>前两部分讲了文件读写的几大核心方法，它们能够起作用的前提就是，需要先打开一个文件对象，因为只有在文件操作符的基础上才可以进行读或者写的操作。</p>
<p>打开文件用的是open()方法，所以我们再继续讲讲这个方法。open() 方法用于打开一个文件，并返回文件对象，在对文件进行处理过程都需要使用到这个函数，如果该文件无法被打开，会抛出 OSError。</p>
<blockquote>
<p>open(file, mode=’r’, buffering=-1, encoding=None, errors=None, newline=None, closefd=True, opener=None)</p>
</blockquote>
<p>open()方法的参数里file（文件）是必需的，其它参数最常用的是mode（模式）和encoding（编码）。</p>
<p>先说说encoding，一般来说，打开文件的编码方式以操作系统的默认编码为准，中文可能会出现乱码，需要加encoding=’utf-8’。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">In [63]: with open(&apos;test.txt&apos;,&apos;r&apos;) as f:</span><br><span class="line">    ...:     for line in f.readlines():</span><br><span class="line">    ...:         print(line.strip())</span><br><span class="line">-----------------------</span><br><span class="line">UnicodeDecodeError     Traceback (most recent call last)</span><br><span class="line">&lt;ipython-input-63-731a4f9cf707&gt; in &lt;module&gt;()</span><br><span class="line">      1 with open(&apos;test.txt&apos;,&apos;r&apos;) as f:</span><br><span class="line">----&gt; 2     for line in f.readlines():</span><br><span class="line">      3         print(line.strip())</span><br><span class="line">UnicodeDecodeError: &apos;gbk&apos; codec can&apos;t decode byte 0xa4 in position 26: illegal multibyte sequence</span><br><span class="line"></span><br><span class="line">In [65]: with open(&apos;test.txt&apos;,&apos;r&apos;,encoding=&apos;utf-8&apos;) as f:</span><br><span class="line">    ...:     for line in f.readlines():</span><br><span class="line">    ...:         print(line.strip())</span><br><span class="line">爱猫猫</span><br><span class="line">python is a cat.</span><br></pre></td></tr></table></figure>
<p>再说mode，它指定文件打开的模式。</p>
<blockquote>
<p>‘r’： 以只读模式打开（缺省模式）（必须保证文件存在）<br>‘w’：以只写模式打开。若文件存在，则清空文件，然后重新创建；若不存在，则新建文件。<br>‘a’：以追加模式打开。若文件存在，则会追加到文件的末尾；若文件不存在，则新建文件。<br>常见的mode组合<br>‘r’或’rt’：     默认模式，文本读模式<br>‘w’或’wt’：  以文本写模式打开（打开前文件会被清空）<br>‘rb’：          以二进制读模式打开<br>‘ab’：         以二进制追加模式打开<br>‘wb’：        以二进制写模式打开（打开前文件会被清空）<br>‘r+’：         以文本读写模式打开，默认写的指针开始指在文件开头, 因此会覆写文件<br>‘w+’：        以文本读写模式打开（打开前文件会被清空）<br>‘a+’：        以文本读写模式打开（写只能写在文件末尾）<br>‘rb+’：       以二进制读写模式打开<br>‘wb+’：     以二进制读写模式打开（打开前文件会被清空）<br>‘ab+’：      以二进制读写模式打开</p>
</blockquote>
<p>喵喵，初看起来，模式很多，但是，它们只是相互组合罢了。建议记住最基本的w、r、a，遇到特殊场景，再翻看一下就好了。</p>
<h2 id="从with语句到上下文管理器"><a href="#从with语句到上下文管理器" class="headerlink" title="从with语句到上下文管理器"></a>从with语句到上下文管理器</h2><p>基础部分讲完了，下面是进阶部分。知其然，更要知其所以然。</p>
<p>1、with语句是初学者必会常识</p>
<p>首先，要解释一下为啥前文直接就用了with语句。with语句是读写文件时的优雅写法，这已经默认是Python初学者必会的常识了。如果你还不会，先看看用和不用with语句的对比：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 不用with语句的正确写法</span><br><span class="line">try:</span><br><span class="line">    f = open(&apos;test.txt&apos;,&apos;w&apos;)</span><br><span class="line">    f.writelines([&apos;python&apos;,&apos; is&apos;,&apos; a&apos;,&apos; cat&apos;])</span><br><span class="line">finally:</span><br><span class="line">    if f:</span><br><span class="line">        f.close()</span><br><span class="line"></span><br><span class="line"># 使用with语句的正确写法</span><br><span class="line">with open(&apos;test.txt&apos;,&apos;w&apos;) as f:</span><br><span class="line">    f.writelines([&apos;python&apos;,&apos; is&apos;,&apos; a&apos;,&apos; cat&apos;])</span><br></pre></td></tr></table></figure>
<p>因为文件对象会占用操作系统的资源，并且操作系统同一时间能打开的文件数量是有限的，所以open()方法之后一定要调用close()方法。另外，读写操作可能出现IO异常的情况，所以要加try…finally，保证无论如何，都会调用到close()方法。</p>
<p>这样写万无一失，但是实在繁琐，一不小心还可能漏写或者写错。而with语句会保证调用close()，只需一行代码，简直不要太优雅！所以，with语句是Python初学者必会技能。</p>
<p>2、什么是上下文管理器？</p>
<p>下面，重头戏来了，什么是上下文管理器（context manager）？</p>
<blockquote>
<p>上下文管理器是这样一个对象：它定义程序运行时需要建立的上下文，处理程序的进入和退出，实现了上下文管理协议，即在对象中定义了 <strong>enter</strong>() 和 <strong>exit</strong>() 方法。<br><strong>enter</strong>()：进入运行时的上下文，返回运行时上下文相关的对象，with 语句中会将这个返回值绑定到目标对象。<br><strong>exit</strong>(exception_type, exception_value, traceback)：退出运行时的上下文，定义在块执行（或终止）之后上下文管理器应该做什么。它可以处理异常、清理现场或者处理 with 块中语句执行完成之后需要处理的动作。</p>
</blockquote>
<p>注意enter和exit的前后有两个下划线，Python中自带了很多类似的方法，它们是很神秘又很强大的存在，江湖人常常称其为“黑魔法”。例如，迭代器协议就实现了<strong>iter</strong>方法。</p>
<p>在Python的内置类型中，很多类型都是支持上下文管理协议的，例如file，thread.LockType，threading.Lock等等。上下文管理器无法独立使用，它们要与with相结合，with语句可以在代码块运行前进入一个运行时上下文（执行<strong>enter</strong>方法），并在代码块结束后退出该上下文（执行<strong>exit</strong>方法）。</p>
<p>with 语句适用于对资源进行访问的场合，确保不管使用过程中是否发生异常都会执行必要的“清理”操作，释放资源，比如文件使用后自动关闭、线程中锁的自动获取和释放等。</p>
<p>3、自定义上下文管理器</p>
<p>除了Python的内置类型，任何人都可以定义自己的上下文管理器。下面是一个示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">class OpenFile(object):</span><br><span class="line">    def __init__(self,filename,mode):</span><br><span class="line">        self.filename=filename</span><br><span class="line">        self.mode=mode</span><br><span class="line">    def __enter__(self):</span><br><span class="line">        self.f=open(self.filename,self.mode)</span><br><span class="line">        self.f.write(&quot;enter now\n&quot;)</span><br><span class="line">        return self.f  #作为as说明符指定的变量的值</span><br><span class="line">    def __exit__(self,type,value,tb):</span><br><span class="line">        self.f.write(&quot;exit now&quot;)</span><br><span class="line">        self.f.close()</span><br><span class="line">        return False   #异常会被传递出上下文</span><br><span class="line">with OpenFile(&apos;test.txt&apos;,&apos;w&apos;) as f:</span><br><span class="line">    f.write(&apos;Hello World!\n&apos;)</span><br></pre></td></tr></table></figure>
<p>最终写入文件的结果是：</p>
<blockquote>
<p>enter now<br>Hello World!<br>exit now</p>
</blockquote>
<p>上下文管理器必须同时提供 <strong>enter</strong>() 和 <strong>exit</strong>() 方法的定义，缺少任何一个都会导致 AttributeError。</p>
<p>上下文管理器在执行过程中可能会出现异常，<strong>exit</strong>() 的返回值会决定异常的处理方式：返回值等于 False，那么这个异常将被重新抛出到上层；返回值等于 True，那么这个异常就被忽略，继续执行后面的代码。<strong>exit</strong>() 有三个参数(exception_type, exception_value, traceback)，即是异常的相关信息。</p>
<p>4、contextlib实现上下文管理器</p>
<p>上例中，自定义上下文管理器的写法还是挺繁琐的，而且只能用于类级别。为了更好地辅助上下文管理，Python 内置提供了 contextlib 模块，进而可以很方便地实现函数级别的上下文管理器。</p>
<p>该模块本质上是通过装饰器(decorators)和生成器(generators)来实现上下文管理器，可以直接作用于函数/对象，而不用去关心 <strong>enter</strong>() 和 <strong>exit</strong>() 方法的具体实现。</p>
<p>先把上面的例子改造一下，然后我们再对照着解释：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">from contextlib import contextmanager</span><br><span class="line"></span><br><span class="line">@contextmanager</span><br><span class="line">def open_file(name):</span><br><span class="line">    ff = open(name, &apos;w&apos;)</span><br><span class="line">    ff.write(&quot;enter now\n&quot;)</span><br><span class="line">    try:</span><br><span class="line">        yield ff</span><br><span class="line">    except RuntimeError:</span><br><span class="line">        pass</span><br><span class="line">    ff.write(&quot;exit now&quot;)</span><br><span class="line">    ff.close()</span><br><span class="line"></span><br><span class="line">with open_file(&apos;test.txt&apos;) as f:</span><br><span class="line">    f.write(&apos;Hello World!\n&apos;)</span><br></pre></td></tr></table></figure>
<p>contextmanager是要使用的装饰器，yield关键字将普通的函数变成了生成器。yield的返回值（ff）等于上例<strong>enter</strong>()的返回值，也就是as语句的值（f），而yield前后的内容，分别是<strong> enter</strong>() 和 <strong>exit</strong>() 方法里的内容。使用contextlib，可以避免类定义、<strong>enter</strong>() 和 <strong>exit</strong>()方法，但是需要我们捕捉可能的异常（例如，yield只能返回一个值，否则会导致异常 RuntimeError），所以try…except语句不能忽略。</p>
<p>-—————-</p>
<p>本文原创并首发于微信公众号【Python猫】，后台回复“爱学习”，免费获得20本精选电子书。</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/05/03/Python进阶/来自Kenneth Reitz大神的建议：避免不必要的面向对象编程/" rel="next" title>
                <i class="fa fa-chevron-left"></i> 
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/05/03/Python进阶/超强汇总：学习Python列表，只需这篇文章就够了/" rel="prev" title>
                 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">John Doe</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">44</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#给Python初学者的文件读写指南（含基础与进阶，建议收藏）"><span class="nav-number">1.</span> <span class="nav-text">给Python初学者的文件读写指南（含基础与进阶，建议收藏）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#如何将列表数据写入文件？"><span class="nav-number">2.</span> <span class="nav-text">如何将列表数据写入文件？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#如何从文件中读取内容？"><span class="nav-number">3.</span> <span class="nav-text">如何从文件中读取内容？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#多样需求的读写任务"><span class="nav-number">4.</span> <span class="nav-text">多样需求的读写任务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#从with语句到上下文管理器"><span class="nav-number">5.</span> <span class="nav-text">从with语句到上下文管理器</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
